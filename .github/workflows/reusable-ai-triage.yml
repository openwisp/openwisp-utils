name: AI Triage

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string
      head_sha:
        required: true
        type: string
      head_repo:
        required: true
        type: string
      base_repo:
        required: true
        type: string
      run_id:
        required: true
        type: string
    secrets:
      GEMINI_API_KEY:
        required: true
      APP_ID:
        required: true
      PRIVATE_KEY:
        required: true

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Bot Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: Checkout Reusable Workflow
        uses: actions/checkout@v4
        with:
          repository: openwisp/openwisp-utils
          ref: issues/524-ci-failure-bot # will change to master upon merge
          path: trusted_scripts

      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.head_repo }}
          ref: ${{ inputs.head_sha }}
          path: pr_code

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Tools
        run: |
          pip install google-genai==1.16.1
          npm install -g repomix@0.3.5

      - name: Fetch CI Logs
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
          RUN_ID: ${{ inputs.run_id }}
          REPO: ${{ inputs.base_repo }}
        run: |
          gh run view $RUN_ID --repo $REPO --log-failed > failed_logs.txt
          if [ ! -s failed_logs.txt ]; then
            echo "No failed logs found or inaccessible run." > failed_logs.txt
          fi

      - name: Pack Context
        run: |
          cd pr_code
          repomix --include "**/*" --ignore "**/*.lock,**/*.json,**/.env*,**/*.secret" --style xml --output ../repo_context.xml

      - name: Run AI Analysis
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python trusted_scripts/.github/scripts/ai_suggest.py > solution.md

      - name: Post Comment
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
          PR_NUM: ${{ inputs.pr_number }}
          REPO: ${{ inputs.base_repo }}
        run: |
          if [ ! -s solution.md ]; then
            echo "AI analysis produced no output; skipping comment."
            exit 0
          fi
          gh pr comment "$PR_NUM" --repo "$REPO" --body-file solution.md
